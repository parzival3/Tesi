\section{Implementazione}
Utilizzando il modulo SX1301 in combinazione con il gateway prodotto da Eurotech
ReliaGATE 10-11, si è andato a sviluppare un software in grado di ricevere i
pacchetti inviati da dispositivi LoRa e inviarli ad un Broker Mqtt.

\subsection{SX1301}
Nella tabella \ref{tab:sx1301_spec} sono riportate le caratteristiche elettriche
massime del  chip SX1301. Il Chip, supporta tensioni di
alimentazione fino a 4V e  come e possibile osservare il range di temperatura in cui il
chip può operare è molto ampio, rendendolo ideali per applicazioni esterne ed
interne. 

\begin{table}[h]
\centering 
\includegraphics[width=16cm]{SX1301_table}
\caption{Caratteristiche elettriche SX1301}
\label{tab:sx1301_spec}
\end{table}
Utilizzando i valori nominali riportati nella tabella \ref{tab:sx1301_spec_1},
si hanno valori di corrente pari a 1[uA] in idle  e di 5[mA] in pieno
funzionamento.
\begin{table}[h]
\centering 
\includegraphics[width=16cm]{SX1301_table_1}
\caption{Caratteristiche elettriche SX1301}
\label{tab:sx1301_spec_1}
\end{table}
Il chip è equipaggiato con un connettore sma al quale è collegata una
antenna omindirezionale, ideata per la frequenza 868[MHz] con un guadagno pari a 3dB.
\subsection{ReliaGATE}
Il gateway a cui è collegato il modulo SX1301 è il ReliaGATE 10-11 prodotto da
Eurotech. Al suo interno troviamo un processore Texas Instruments TI AM335X Cortex-A8 
equipaggiato con 512MB di RAM e 4GB di storage eMMC. Il ReliaGATE offre una
vasta gamma di porte tra cui 232/485, 2CAN bus, 2 porte USB e 2 porte Ethernet,
inoltre ha connettività Bluetooth, WiFi e GPS. Al suo interno è installo
Everyware™ Software Framework (ESF), la versione commerciale del software Kura.
\begin{figure}[h]
\centering 
\includegraphics[width=11cm]{Reliagate_10_11}
\caption{Caratteristiche elettriche SX1301}
\label{fig:ReliaGATE}
\end{figure}


\subsection{Architettura del software}
Lo scopo di questa tesi era riuscire ad implementare dei moduli osgi,
installabili al interno del framework ESF, in grado di controllare il
comportamento del devices SX1301. In particolare utilizzando l'utility messa a
disposizione da Semtech per l'interfacciamento con il dispositivo denominata
packet forwarder, e l'utility LoRa Gateway Bridge , sotto licenza MIT,
sviluppata da brocaar \improvement{Aggiunger link}.

\begin{figure}[h]
\centering 
\includegraphics[width=11cm]{Application_layer}
\caption{Architettura del software}
\label{fig:Software_stack}
\end{figure}

\subsection{Semtech packet forwarder}
Il packet forwarder, è un software il quale riceve o invia pacchetti radio Lora ,
tramite una connessione SPI con il device SX1301. Nel caso di ricezione di un
pacchetto, l'applicativo incapsula i dati ricevuti in un formato IP/UDP, e li
ritrasmette nella rete internet/intranet. Per la sua configurazione viene
utilizzato un file Json nel quale trviamo tutte le varie opzioni di
configurazione per i moduli radio presenti al interno del chip.
\inputminted[mathescape, gobble=2, frame=lines, linenos=true
framesep=2mm, firstline=1,lastline=23]{json}{Code_Files/global_json.conf}
\inputminted[mathescape, gobble=2, frame=lines, linenos=true
framesep=2mm, firstline=173,lastline=184]{json}{Code_Files/global_json.conf}

\subsection{LoRa Gateway Bridge}
LoRa Gateway Bridge, è l'applicativo il quale riceve i vari pachetti UDP inviati
dal packet forwarder e li trasmette ad un Broker MQTT. Il software è scritto nel
linguaggio GO. Per renderlo interfacciabile con ESF, sono state apportate delle 
modifiche al codice, in particolare è stata aggiunta la possibilità di
specificare il publish e il subscribed topic, i quali erano hard-coded.

\subsection{ESF}
Everyware software framework, è la versione commerciale del software Kura
preinstallata nel ReliaGATE 10-11. ESF si pone l'obiettivo di offrire un
container Java/OSGi per le applicazioni M2M. Gli applicativi installati in ESF
sono sviluppati come OSGi Declarative Service, dando la possibilità di
configurare i vari applicativi del gateway tramite una semplice interfaccia web.

\begin{figure}[h]
\centering 
\includegraphics[width=16cm]{ESF.png}
\caption{Architettura del software}
\label{fig:Software_stack}
\end{figure}

\subsection{Realizzazione}
Per gestire i due software preinstallati si è optato per la creazione di due
applicativi osgi distinti.
Il primo applicativo chiamato Lora Config si pone il compito di leggere ed
interpretare il file di configurazione utilizzato dal programma \emph{Packet
Forwarder}, per poi andare ad esporre i punti principali al utente finale.
La libreria utilizzata per manipolare i file di tipo Json è 

\mint{Java}|import com.eclipsesource.json|

Tramite la quale vengono riempiti i campi della classe LoraSettings. Il file
Json, come detto precedentemente è composto da due parti. Nella prima parte
troviamo tutte le impostazioni per la configurazione del SX1301, nella seconda
parte sono presenti le impostazioni per il forward dei pacchetti. Per questa
ragione due classi diverse sono state create, SX1301Configuration e
GatewayConfiguration, accessibili tramite la classe LoraSettings.

\begin{minted}[linenos=true, numbersep=5pt, gobble=2, frame=lines, %
framesep=2mm]{java}
    public class LoraSettings {
            public static final String KEY_GATEWAY_CONFIG = "gateway_conf";
            public static final String KEY_SX1301 = "SX1301_conf";
            private SX1301Configuration sx1301Conf;
            private GatewayConfiguration gatewayConf;
        }
\end{minted}

\begin{lstlisting}[language=Java, frame=single]  % Start your code-block


import org.apache.commons.exec

\end{lstlisting}
